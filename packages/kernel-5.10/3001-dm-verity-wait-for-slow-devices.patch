From: Nathan Barrett-Morrison <nathan.morrison@timesys.com>
Date: Wed, 30 Mar 2022 10:54:01 -0400
Subject: [PATCH 1/3] DM-Verity: Wait up to 10 seconds for eMMC/SD partitions
 to show up before failing dm_get_device()

---
 drivers/md/dm-verity-target.c | 16 ++++++++++++----
 1 file changed, 12 insertions(+), 4 deletions(-)

diff --git a/drivers/md/dm-verity-target.c b/drivers/md/dm-verity-target.c
index 711f101447e3..3fb02167a590 100644
--- a/drivers/md/dm-verity-target.c
+++ b/drivers/md/dm-verity-target.c
@@ -18,6 +18,7 @@
 #include "dm-verity-verify-sig.h"
 #include <linux/module.h>
 #include <linux/reboot.h>
+#include <linux/delay.h>
 
 #define DM_MSG_PREFIX			"verity"
 
@@ -1023,10 +1024,17 @@ static int verity_ctr(struct dm_target *ti, unsigned argc, char **argv)
 	}
 	v->version = num;
 
-	r = dm_get_device(ti, argv[1], FMODE_READ, &v->data_dev);
-	if (r) {
-		ti->error = "Data device lookup failed";
-		goto bad;
+	//Wait up to 10 seconds for devices to become available --
+	//wait_for_device_probe() sort of handles this, but the eMMC/SD probe finishes
+	//and dm_get_device() fails before the eMMC/SD partitions are found
+	for(i = 0; i <= 100; i++){
+		r = dm_get_device(ti, argv[1], FMODE_READ, &v->data_dev);
+		if (r && i < 100) {
+			msleep_interruptible(100);
+		}else if(r){
+			ti->error = "Data device lookup failed";
+			goto bad;
+		}
 	}
 
 	r = dm_get_device(ti, argv[2], FMODE_READ, &v->hash_dev);
-- 
2.38.1

